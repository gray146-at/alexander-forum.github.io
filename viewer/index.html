<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>PDF-Viewer | Alexander Forum</title>
  <meta name="robots" content="noindex,follow">
  <meta name="theme-color" content="#0f2a3a">
  <style>
    :root{ --navy:#0f2a3a; --ink:#121416; --bg:#f7f8fa; --border:#e6eaee; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#fff;color:var(--ink);font-family:Georgia,"Times New Roman",serif}
    .bar{display:flex;gap:.5rem;align-items:center;justify-content:space-between;padding:.5rem .75rem;border-bottom:1px solid var(--border);background:var(--bg)}
    .left{display:flex;gap:.5rem;align-items:center}
    .brand{font-weight:700;color:var(--navy);font-size:1rem;margin-left:.25rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60vw}
    .btn{display:inline-block;text-decoration:none;border:1px solid var(--border);padding:.45rem .7rem;border-radius:8px;min-height:40px;line-height:1;color:var(--navy);background:#fff}
    .btn.primary{background:var(--navy);color:#fff;border-color:rgba(0,0,0,.06)}
    .btn:hover{background:#f0f3f5}.btn.primary:hover{background:#1c3c4f}
    .frame{width:100%;height:calc(100vh - 57px);border:0;display:block;background:#fff}
    @media (max-width:600px){ .brand{display:none} .frame{height:calc(100vh - 54px)} }
  </style>
</head>
<body>
  <div class="bar" role="navigation" aria-label="PDF-Viewer Navigation">
    <div class="left">
      <a class="btn" id="backBtn" href="/">← Zurück</a>
      <span class="brand" id="brand">Alexander Forum · PDF</span>
    </div>
    <div class="right">
      <a class="btn primary" id="dl" download>PDF herunterladen</a>
    </div>
  </div>

  <iframe class="frame" id="frame" title="PDF-Ansicht"></iframe>

  <script>
    (function(){
      const p = new URLSearchParams(location.search);
      const raw   = p.get('file')   || '';
      const title = p.get('title')  || '';
      const ret   = p.get('return') || ''; // optionaler Rücksprung

      // Datei nur gleiche Domain/relativ zulassen
      let file = '';
      try{
        if(raw.startsWith('/')) file = raw;
        else if(!raw.startsWith('http')) file = '/' + raw.replace(/^\.?\//,'');
        else {
          const u = new URL(raw, location.origin);
          if(u.origin === location.origin) file = u.pathname + u.search + u.hash;
        }
      }catch(e){}

      // Titel setzen
      const brand = document.getElementById('brand');
      if(!file || !file.endsWith('.pdf')){
        brand.textContent = 'Datei nicht gefunden oder ungültig.';
        return;
      }
      if(title){
        document.title = title + ' | Alexander Forum';
        brand.textContent = title;
      }else{
        brand.textContent = 'Alexander Forum · ' + (file.split('/').pop() || 'PDF');
      }

      // Iframe & Download
      const url = file + (file.includes('#') ? '' : '#page=1&zoom=page-width');
      document.getElementById('frame').src = url;
      const dl = document.getElementById('dl');
      dl.href = file;
      dl.setAttribute('aria-label','PDF herunterladen: ' + (title || file));

      // Zurück-Button-Logik:
      // 1) Wenn echte History vorhanden: history.back()
      // 2) sonst: zu return=... (falls gesetzt und same-origin)
      // 3) sonst: zur Startseite (DE: '/'; EN-Seite verlinkt return=/en/#downloads)
      const backBtn = document.getElementById('backBtn');
      function sameOrigin(url){
        try{ return new URL(url, location.origin).origin === location.origin; }catch(e){ return false; }
      }
      const defaultReturn = '/#downloads';
      let fallback = defaultReturn;
      if(ret && sameOrigin(ret)) fallback = new URL(ret, location.origin).pathname + new URL(ret, location.origin).hash;

      backBtn.addEventListener('click', function(e){
        e.preventDefault();
        if(history.length > 1) history.back();
        else location.href = fallback;
      });

      // Label anpassen, wenn kein Verlauf existiert
      if(history.length <= 1){
        backBtn.textContent = '← Zur Startseite';
      }
    })();
  </script>
</body>
</html>
